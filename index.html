<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utah Preterm Births - Comprehensive Analysis</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ffd4c4 0%, #ffc4b8 50%, #ffb8aa 100%);
            color: #4a2c2a;
        }

        .dashboard-container { display: flex; flex-direction: column; min-height: 100vh; }

        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, #ff9a8b 0%, #ff7e7e 100%);
            padding: 1.5rem 2rem;
            border-bottom: 3px solid #e86a5d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(232, 106, 93, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .title-section h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: #0f172a;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .title-section p { color: rgba(255, 255, 255, 0.95); font-size: 0.9rem; }

        .controls-wrapper {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .year-control-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; }

        .interaction-hint {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fff4e6;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .interaction-hint::before, .interaction-hint::after { content: 'â†’'; font-size: 0.9rem; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .year-control, .county-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.25);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        /* County control when used inline in content */
        .county-specific .county-control {
            background: rgba(255, 154, 139, 0.2);
            border: 2px solid #ffb8aa;
            backdrop-filter: none;
        }

        .year-control label { 
            color: white; 
            font-size: 0.95rem; 
            font-weight: 600; 
        }
        
        .county-control label { 
            color: #0f172a; 
            font-size: 0.95rem; 
            font-weight: 600; 
        }

        .year-control select, .county-control select {
            padding: 0.5rem 1.5rem;
            background: white;
            border: 2px solid #e86a5d;
            border-radius: 8px;
            color: #d64933;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(232, 106, 93, 0.2);
        }

        .year-control select:hover, .county-control select:hover {
            background: #fff8f5;
            border-color: #ff7e7e;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(232, 106, 93, 0.3);
        }

        /* Main Content - Split Layout */
        .dashboard-main { 
            display: grid;
            grid-template-columns: 420px 1fr;
            height: calc(100vh - 85px);
        }

        /* Left Side - Fixed Map Section */
        .left-fixed-section {
            position: sticky;
            top: 85px;
            height: calc(100vh - 85px);
            overflow-y: auto;
        }

        /* Right Side - Scrollable Content */
        .right-scrollable-section {
            overflow-y: auto;
            height: calc(100vh - 85px);
        }

        .section-wrapper {
            margin-bottom: 2px;
        }

        /* Map Section Styling */
        .map-section {
            background: rgba(255, 255, 255, 0.95);
            border-right: 3px solid #ffb8aa;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 6px rgba(255, 154, 139, 0.15);
            min-height: 100%;
        }

        .map-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem; color: #0f172a; }

        .map-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 400px;
            background: rgba(255, 212, 196, 0.3);
            border-radius: 12px;
            padding: 1rem;
        }

        .map-legend {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 184, 170, 0.2);
            border-radius: 8px;
            border: 1px solid #ffb8aa;
        }

        .legend-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem; color: #0f172a; }
        .legend-items { display: flex; flex-direction: column; gap: 0.5rem; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: #1f2937; }
        .legend-color { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #0f172a; }

        .viz-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
            background: #ffb8aa;
            min-height: 500px;
        }

        .viz-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }

        .viz-header { margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #ffd4c4; }
        .viz-header h3 { font-size: 1rem; font-weight: 600; color: #0f172a; margin-bottom: 0.25rem; }
        .viz-header p { font-size: 0.8rem; color: #6b7280; }
        .viz-content { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; min-height: 200px; }

        /* New Sections */
        .full-width-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            margin: 2px 0;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #ffd4c4;
        }

        .section-subtitle {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 2rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-top: 2rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #ffd4c4;
            box-shadow: 0 2px 8px rgba(255, 154, 139, 0.1);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.5rem;
        }

        .chart-description {
            font-size: 0.85rem;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        /* County Specific Section */
        .county-specific {
            background: linear-gradient(135deg, rgba(255, 212, 196, 0.5) 0%, rgba(255, 196, 184, 0.5) 100%);
            padding: 2rem;
            margin: 2px 0;
        }

        svg { width: 100%; height: 100%; }
        .county-circle, .bar, .heatmap-cell, .line-point { cursor: pointer; transition: all 0.2s ease; }
        .county-circle:hover, .line-point:hover { filter: brightness(1.1); }
        .bar:hover rect, .heatmap-cell:hover rect { opacity: 0.8; }
        
        .county-text, .heatmap-text { pointer-events: none; fill: #2d1a18; font-weight: 600; }
        .axis-label { fill: #4b5563; font-size: 11px; }
        .axis-line { stroke: #ffb8aa; stroke-width: 2; }
        .heatmap-label { fill: #4b5563; font-size: 11px; }

        .loading { text-align: center; color: #ff7e7e; padding: 2rem; }
        .error { text-align: center; color: #dc2626; padding: 1rem; background: rgba(220, 38, 38, 0.1); border-radius: 8px; font-size: 0.9rem; border: 1px solid #fca5a5; }

        .tooltip {
            position: fixed;
            background: linear-gradient(135deg, #d64933 0%, #ff7e7e 100%);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            border: 2px solid #ff9a8b;
            box-shadow: 0 4px 12px rgba(214, 73, 51, 0.4);
            max-width: 250px;
        }

        .tooltip.show { opacity: 1; }
        .tooltip-title { font-weight: 600; margin-bottom: 0.25rem; }
        .tooltip-value { color: rgba(255, 255, 255, 0.95); font-size: 0.8rem; }

        .insight-box {
            background: rgba(255, 212, 196, 0.3);
            border-left: 4px solid #0f172a;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .insight-box h4 {
            color: #0f172a;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .insight-box p {
            color: #1f2937;
            font-size: 0.85rem;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 350px;
            color: #9ca3af;
            text-align: center;
            padding: 2rem;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .empty-state-text {
            font-size: 1rem;
            font-weight: 500;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="title-section">
                <h1>Utah Preterm Births - Comprehensive Analysis</h1>
                <p>32-33 Weeks Gestation â€¢ 2008-2012 â€¢ Multi-Dimensional Data Explorer</p>
            </div>
            <div class="year-control-wrapper">
                <div class="interaction-hint">You Can Interact Here</div>
                <div class="year-control">
                    <label for="year-select">Year:</label>
                    <select id="year-select">
                        <option value="2012" selected>2012</option>
                        <option value="2011">2011</option>
                        <option value="2010">2010</option>
                        <option value="2009">2009</option>
                        <option value="2008">2008</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-main">
            <!-- Left Side - FIXED MAP -->
            <div class="left-fixed-section">
                <div class="map-section">
                    <h2 class="map-title">Geographic Distribution</h2>
                    <div class="map-container" id="map-container">
                        <div class="loading">Loading map...</div>
                    </div>
                    <div class="map-legend">
                        <div class="legend-title">Preterm Birth Rate</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #4ade80;"></div>
                                <span>Low (&lt;1.0%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #fbbf24;"></div>
                                <span>Moderate (1.0-1.3%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #fb923c;"></div>
                                <span>Elevated (1.3-1.7%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f87171;"></div>
                                <span>High (&gt;1.7%)</span>
                            </div>
                        </div>
                        <div class="legend-title" style="margin-top: 1rem;">Circle Size</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <span>Proportional to total births</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side - SCROLLABLE CONTENT -->
            <div class="right-scrollable-section">
                <!-- Top: Age & Race Charts -->
                <div class="viz-section">
                    <div class="viz-panel">
                        <div class="viz-header">
                            <h3>Preterm Births by Maternal Age</h3>
                            <p>Rate by age group</p>
                        </div>
                        <div class="viz-content" id="age-chart">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <div class="viz-panel">
                        <div class="viz-header">
                            <h3>Preterm Births by Race/Ethnicity</h3>
                            <p>Rate by demographic group</p>
                        </div>
                        <div class="viz-content" id="race-chart">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <div class="viz-panel">
                        <div class="viz-header">
                            <h3>Age Group Trends</h3>
                            <p>Cases by year and age</p>
                        </div>
                        <div class="viz-content" id="age-heatmap">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <div class="viz-panel">
                        <div class="viz-header">
                            <h3>Race/Ethnicity Trends</h3>
                            <p>Cases by year and demographic</p>
                        </div>
                        <div class="viz-content" id="race-heatmap">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Age-Focused Analysis Section -->
                <div class="section-wrapper">
                    <div class="full-width-section">
                        <h2 class="section-title">Age-Focused Analysis</h2>
                        <p class="section-subtitle">Deep dive into maternal age patterns and risk factors</p>
                        
                        <div class="chart-grid">
                            <div class="chart-container">
                                <h3 class="chart-title">Teen Births Analysis (&lt;18 Years)</h3>
                                <p class="chart-description">Teen mothers vs. adult mothers comparison</p>
                                <div id="teen-births-chart" style="min-height: 350px;"></div>
                            </div>

                            <div class="chart-container">
                                <h3 class="chart-title">Advanced Maternal Age (35+)</h3>
                                <p class="chart-description">Risk increases with maternal age</p>
                                <div id="advanced-age-chart" style="min-height: 350px;"></div>
                            </div>

                            <div class="chart-container" style="grid-column: 1 / -1;">
                                <h3 class="chart-title">Age Group Comparison Bubble Chart</h3>
                                <p class="chart-description">Bubble size = total births, position shows rate and count</p>
                                <div id="age-bubble-chart" style="min-height: 400px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- County-Specific Analysis Section -->
                <div class="section-wrapper">
                    <div class="county-specific">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <div>
                                <h2 class="section-title" style="margin-bottom: 0.5rem;">County-Specific Analysis</h2>
                                <p class="section-subtitle" style="margin-bottom: 0;">Select a county from the dropdown to view detailed analysis</p>
                            </div>
                            <div class="county-control">
                                <label for="county-select">Select County:</label>
                                <select id="county-select">
                                    <option value="all" selected>-- Select County --</option>
                                    <!-- Counties will be dynamically populated -->
                                </select>
                            </div>
                        </div>
                        
                        <div id="county-detail-content">
                            <div class="chart-grid">
                                <div class="chart-container">
                                    <h3 class="chart-title">Trend Over Time</h3>
                                    <p class="chart-description">County rate vs. state average (2008-2012)</p>
                                    <div id="county-age-chart" style="min-height: 350px;">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">ðŸ“Š</div>
                                            <div class="empty-state-text">Select a county to view trend analysis</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="chart-container">
                                    <h3 class="chart-title">Cases by Year</h3>
                                    <p class="chart-description">Annual case count and rate</p>
                                    <div id="county-race-chart" style="min-height: 350px;">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">ðŸ“ˆ</div>
                                            <div class="empty-state-text">Select a county to view case analysis</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="county-insights-box" style="display: none;">
                                <div class="insight-box" id="county-insights">
                                    <h4>Key Insights for <span id="selected-county-name">County</span></h4>
                                    <p id="insight-text">Loading insights...</p>
                                </div>
                            </div>

                            <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(255, 212, 196, 0.2); border-radius: 12px; border: 1px solid #ffb8aa;">
                                <p style="color: #1f2937; font-size: 0.9rem; text-align: center;">
                                    <strong>Note:</strong> Ethnicity-specific data at the county level is not available in this dataset. 
                                    The data contains only total counts per county per year. For ethnicity breakdowns, please refer to the 
                                    state-level Race/Ethnicity charts above.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const CSV_URL = 'Preterm_Births_32-33_Weeks_Gestation_Counties_In_Utah_2003-2012_20260122.csv';
        
        const COUNTY_POSITIONS = {
            'Utah - Cache': { x: 52, y: 15, name: 'Cache' },
            'Utah - Weber': { x: 52, y: 30, name: 'Weber' },
            'Utah - Davis': { x: 50, y: 38, name: 'Davis' },
            'Utah - Salt Lake': { x: 50, y: 50, name: 'Salt Lake' },
            'Utah - Utah': { x: 50, y: 65, name: 'Utah' },
            'Utah - Washington': { x: 25, y: 90, name: 'Washington' },
            'Utah - Box Elder': { x: 52, y: 22, name: 'Box Elder' },
            'Utah - Tooele': { x: 35, y: 50, name: 'Tooele' },
            'Utah - Iron': { x: 25, y: 80, name: 'Iron' },
            'Utah - Sevier': { x: 40, y: 70, name: 'Sevier' },
            'Utah - Uintah': { x: 75, y: 40, name: 'Uintah' }
        };

        let allData = {};
        let stateData = {};
        let countyDataAllYears = {};
        const tooltip = document.getElementById('tooltip');

        function getColorForRate(rate) {
            if (!rate) return '#e5e7eb';
            const rateNum = parseFloat(rate);
            if (rateNum < 1.0) return '#4ade80';
            if (rateNum < 1.3) return '#fbbf24';
            if (rateNum < 1.7) return '#fb923c';
            return '#f87171';
        }

        function showTooltip(html, event) {
            tooltip.innerHTML = html;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            tooltip.classList.remove('show');
        }

        async function loadCSV() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('map-container').innerHTML = '<div class="error">Could not load CSV file.</div>';
                return null;
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const firstLine = lines[0];
            const headers = [];
            let inQuotes = false;
            let currentField = '';
            
            for (let i = 0; i < firstLine.length; i++) {
                const char = firstLine[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    headers.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            headers.push(currentField.trim());
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const line = lines[i];
                const values = [];
                inQuotes = false;
                currentField = '';
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                values.push(currentField.trim());
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                data.push(row);
            }
            
            return { headers, data };
        }

        function processData(csvData) {
            const countyData = {};
            const stateDataByYear = {};
            const allCountyData = {};
            const validYears = ['2008', '2009', '2010', '2011', '2012'];
            
            csvData.data.forEach(row => {
                const timeframe = row['Timeframe'];
                const locale = row['Locale'];
                const localeLevel = row['Locale Level'];
                const dimensionList = row['Dimension List'];
                const numericValue = row['Numeric Value'];
                const numerator = row['Numerator'];
                const denominator = row['Denominator'];
                const age = row['Age'];
                const raceEthnicity = row['Race Ethnicity'];
                
                if (!validYears.includes(timeframe)) return;
                if (numericValue === 'DSU' || !numericValue || numericValue === '') return;
                
                const year = timeframe;
                
                // Process county data
                if (localeLevel === 'County' && dimensionList === 'Total') {
                    const position = COUNTY_POSITIONS[locale];
                    if (!position) return;
                    
                    if (!countyData[year]) countyData[year] = {};
                    if (!allCountyData[position.name]) allCountyData[position.name] = {};
                    if (!allCountyData[position.name][year]) allCountyData[position.name][year] = {};
                    
                    const cleanNumerator = numerator.replace(/,/g, '');
                    const cleanDenominator = denominator.replace(/,/g, '');
                    
                    const dataPoint = {
                        rate: parseFloat(numericValue.replace('%', '')),
                        count: parseInt(cleanNumerator) || 0,
                        totalBirths: parseInt(cleanDenominator) || 0,
                        x: position.x,
                        y: position.y,
                        name: position.name
                    };
                    
                    countyData[year][locale] = dataPoint;
                    allCountyData[position.name][year] = dataPoint;
                }
                
                // Process state data
                if (localeLevel === 'State' && locale === 'Utah') {
                    if (!stateDataByYear[year]) {
                        stateDataByYear[year] = { age: {}, race: {} };
                    }
                    
                    // Process age data - FIXED: Look for simple age dimension without race
                    if (age && age !== '' && !raceEthnicity) {
                        // Clean the age string
                        let ageGroup = age.replace('Aged ', '').replace(' years', '').replace(' (Of mother)', '').trim();
                        
                        // Map "40 years and over" to "40 and over"
                        if (ageGroup === '40 and over') {
                            ageGroup = '40 and over';
                        }
                        
                        // Map "<18" to keep it consistent
                        if (ageGroup === '<18') {
                            ageGroup = '<18';
                        }
                        
                        if (!stateDataByYear[year].age[ageGroup]) {
                            const cleanNum = numerator.replace(/,/g, '');
                            const cleanDenom = denominator.replace(/,/g, '');
                            stateDataByYear[year].age[ageGroup] = {
                                rate: parseFloat(numericValue.replace('%', '')),
                                count: parseInt(cleanNum) || 0,
                                total: parseInt(cleanDenom) || 0
                            };
                        }
                    }
                    
                    // Process race/ethnicity data - FIXED: Check dimension list column
                    // The data has race in both "Dimension List" and "Race Ethnicity" columns
                    // We want rows where the dimension list is the race name (without "Total")
                    if (raceEthnicity && raceEthnicity !== '' && !age) {
                        const cleanNum = numerator.replace(/,/g, '');
                        const cleanDenom = denominator.replace(/,/g, '');
                        const rateValue = parseFloat(numericValue.replace('%', ''));
                        const countValue = parseInt(cleanNum) || 0;
                        const totalValue = parseInt(cleanDenom) || 0;
                        
                        // Clean up the race name
                        let raceName = raceEthnicity.replace(' (Of mother)', '').trim();
                        
                        // Only store main categories, not sub-categories
                        // Main categories: White, Black or African American, American Indian or Alaska Native, 
                        // Asian or Pacific Islander, Hispanic or Latino, Mexican
                        const mainCategories = [
                            'White',
                            'Black or African American',
                            'American Indian or Alaska Native',
                            'Asian or Pacific Islander',
                            'Hispanic or Latino',
                            'Mexican',
                            'Not Hispanic or Latino',
                            'White, non-Hispanic',
                            'Black or African American, non-Hispanic'
                        ];
                        
                        if (mainCategories.includes(raceName)) {
                            if (!stateDataByYear[year].race[raceName]) {
                                stateDataByYear[year].race[raceName] = {
                                    rate: rateValue,
                                    count: countValue,
                                    total: totalValue
                                };
                            }
                        }
                    }
                }
            });
            
            return { countyData, stateDataByYear, allCountyData };
        }

        function renderMap(year) {
            const yearData = allData[year];
            if (!yearData || Object.keys(yearData).length === 0) {
                document.getElementById('map-container').innerHTML = '<div class="error">No data for ' + year + '</div>';
                return;
            }

            const maxBirths = Math.max(...Object.values(yearData).map(d => d.totalBirths));
            const minBirths = Math.min(...Object.values(yearData).map(d => d.totalBirths));

            let svgHTML = `
                <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg" style="max-width: 350px;">
                    <path d="M 30 5 L 70 5 L 70 110 L 30 110 L 30 85 L 20 85 L 20 30 L 30 30 Z" 
                          fill="rgba(255, 184, 170, 0.2)" 
                          stroke="#ffb8aa" 
                          stroke-width="1"/>
            `;
            
            Object.entries(yearData).forEach(([locale, data]) => {
                const cx = data.x;
                const cy = data.y;
                const r = 5 + ((data.totalBirths - minBirths) / (maxBirths - minBirths)) * 7;
                const color = getColorForRate(data.rate);
                
                svgHTML += `
                    <g class="county-circle" data-county="${data.name}" data-rate="${data.rate}" data-count="${data.count}" data-births="${data.totalBirths}">
                        <circle cx="${cx}" cy="${cy}" r="${r}" fill="${color}" opacity="0.9" 
                                stroke="#d64933" stroke-width="1"/>
                        <text x="${cx}" y="${cy + 1}" text-anchor="middle" class="county-text" font-size="3">${data.rate.toFixed(1)}%</text>
                    </g>
                `;
            });
            
            svgHTML += '</svg>';
            document.getElementById('map-container').innerHTML = svgHTML;
            
            document.querySelectorAll('.county-circle').forEach(circle => {
                circle.addEventListener('mouseenter', function(e) {
                    const name = this.dataset.county;
                    const rate = this.dataset.rate;
                    const count = this.dataset.count;
                    const births = parseInt(this.dataset.births).toLocaleString();
                    showTooltip(`<div class="tooltip-title">${name} County</div><div class="tooltip-value">Rate: ${parseFloat(rate).toFixed(1)}%<br>Cases: ${count}<br>Total Births: ${births}</div>`, e);
                });
                circle.addEventListener('mouseleave', hideTooltip);
                circle.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function renderAgeChart(year) {
            const data = stateData[year]?.age;
            if (!data) {
                document.getElementById('age-chart').innerHTML = '<div class="error">No age data</div>';
                return;
            }

            const ageGroups = ['15-19', '20-24', '25-29', '30-34', '35-39', '40 and over'];
            const chartData = ageGroups.filter(ag => data[ag]).map(ag => ({ age: ag, ...data[ag] }));

            if (chartData.length === 0) {
                document.getElementById('age-chart').innerHTML = '<div class="error">No data</div>';
                return;
            }

            const maxRate = Math.max(...chartData.map(d => d.rate));
            const barHeight = 35;
            const padding = { top: 10, right: 60, bottom: 25, left: 80 };
            const chartHeight = chartData.length * barHeight + padding.top + padding.bottom;
            const chartWidth = 500;

            let svgHTML = `<svg viewBox="0 0 ${chartWidth} ${chartHeight}" xmlns="http://www.w3.org/2000/svg">`;
            
            chartData.forEach((d, i) => {
                const barWidth = (d.rate / maxRate) * (chartWidth - padding.left - padding.right);
                const y = padding.top + i * barHeight;
                
                svgHTML += `
                    <g class="bar" data-age="${d.age}" data-rate="${d.rate}" data-count="${d.count}">
                        <text x="${padding.left - 10}" y="${y + 18}" text-anchor="end" class="axis-label">${d.age}</text>
                        <rect x="${padding.left}" y="${y}" width="${barWidth}" height="${barHeight - 10}" 
                              fill="${getColorForRate(d.rate)}" rx="4"/>
                        <text x="${padding.left + barWidth + 5}" y="${y + 18}" class="axis-label" fill="#d64933" font-weight="600">${d.rate.toFixed(1)}%</text>
                    </g>
                `;
            });
            
            svgHTML += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${chartHeight - padding.bottom}" class="axis-line"/></svg>`;
            
            document.getElementById('age-chart').innerHTML = svgHTML;
            
            document.querySelectorAll('#age-chart .bar').forEach(bar => {
                bar.addEventListener('mouseenter', function(e) {
                    const age = this.dataset.age;
                    const rate = this.dataset.rate;
                    const count = this.dataset.count;
                    showTooltip(`<div class="tooltip-title">Age ${age}</div><div class="tooltip-value">Rate: ${parseFloat(rate).toFixed(1)}%<br>Cases: ${count}</div>`, e);
                });
                bar.addEventListener('mouseleave', hideTooltip);
                bar.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function renderRaceChart(year) {
            const data = stateData[year]?.race;
            if (!data) {
                document.getElementById('race-chart').innerHTML = '<div class="error">No race data</div>';
                return;
            }

            // Get all races that have data for this year and sort by rate
            const chartData = Object.entries(data)
                .map(([race, values]) => ({ race, ...values }))
                .sort((a, b) => b.rate - a.rate);

            if (chartData.length === 0) {
                document.getElementById('race-chart').innerHTML = '<div class="error">No data</div>';
                return;
            }

            const maxRate = Math.max(...chartData.map(d => d.rate), 1);
            const barHeight = 35;
            const padding = { top: 10, right: 60, bottom: 25, left: 220 };
            const chartHeight = chartData.length * barHeight + padding.top + padding.bottom;
            const chartWidth = 500;

            let svgHTML = `<svg viewBox="0 0 ${chartWidth} ${chartHeight}" xmlns="http://www.w3.org/2000/svg">`;
            
            chartData.forEach((d, i) => {
                const barWidth = d.rate > 0 ? (d.rate / maxRate) * (chartWidth - padding.left - padding.right) : 0;
                const y = padding.top + i * barHeight;
                const displayName = d.race.length > 28 ? d.race.substring(0, 25) + '...' : d.race;
                
                svgHTML += `
                    <g class="bar" data-race="${d.race}" data-rate="${d.rate}" data-count="${d.count}">
                        <text x="${padding.left - 10}" y="${y + 18}" text-anchor="end" class="axis-label">${displayName}</text>
                        <rect x="${padding.left}" y="${y}" width="${barWidth}" height="${barHeight - 10}" 
                              fill="${getColorForRate(d.rate)}" rx="4"/>
                        <text x="${padding.left + barWidth + 5}" y="${y + 18}" class="axis-label" fill="#0f172a" font-weight="600">${d.rate.toFixed(1)}%</text>
                    </g>
                `;
            });
            
            svgHTML += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${chartHeight - padding.bottom}" class="axis-line"/></svg>`;
            
            document.getElementById('race-chart').innerHTML = svgHTML;
            
            document.querySelectorAll('#race-chart .bar').forEach(bar => {
                bar.addEventListener('mouseenter', function(e) {
                    const race = this.dataset.race;
                    const rate = this.dataset.rate;
                    const count = this.dataset.count;
                    showTooltip(`<div class="tooltip-title">${race}</div><div class="tooltip-value">Rate: ${parseFloat(rate).toFixed(1)}%<br>Cases: ${count}</div>`, e);
                });
                bar.addEventListener('mouseleave', hideTooltip);
                bar.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function renderAgeHeatmap() {
            const years = ['2008', '2009', '2010', '2011', '2012'];
            const ageGroups = ['15-19', '20-24', '25-29', '30-34', '35-39', '40 and over'];
            
            const heatmapData = years.map(year => {
                const yearData = stateData[year]?.age || {};
                return ageGroups.map(ag => yearData[ag]?.count || 0);
            });

            const maxValue = Math.max(...heatmapData.flat());
            const cellWidth = 60;
            const cellHeight = 40;
            const padding = { top: 30, right: 10, bottom: 10, left: 80 };
            
            let svgHTML = `<svg viewBox="0 0 ${cellWidth * years.length + padding.left + padding.right} ${cellHeight * ageGroups.length + padding.top + padding.bottom}" 
                     xmlns="http://www.w3.org/2000/svg">`;
                     
            years.forEach((year, i) => {
                svgHTML += `<text x="${padding.left + i * cellWidth + cellWidth/2}" y="${padding.top - 10}" 
                          text-anchor="middle" class="heatmap-label">${year}</text>`;
            });
            
            ageGroups.forEach((ag, j) => {
                svgHTML += `<text x="${padding.left - 10}" y="${padding.top + j * cellHeight + cellHeight/2 + 5}" 
                          text-anchor="end" class="heatmap-label">${ag}</text>`;
            });
            
            heatmapData.forEach((yearData, i) => {
                yearData.forEach((value, j) => {
                    const intensity = value / maxValue;
                    const color = `rgba(255, 126, 126, ${intensity * 0.7 + 0.3})`;
                    const x = padding.left + i * cellWidth;
                    const y = padding.top + j * cellHeight;
                    
                    svgHTML += `
                        <g class="heatmap-cell" data-year="${years[i]}" data-age="${ageGroups[j]}" data-count="${value}">
                            <rect x="${x}" y="${y}" width="${cellWidth-2}" height="${cellHeight-2}" 
                                  fill="${color}" stroke="#ffb8aa" stroke-width="1" rx="4"/>
                            <text x="${x + cellWidth/2}" y="${y + cellHeight/2 + 5}" 
                                  text-anchor="middle" class="heatmap-text">${value}</text>
                        </g>
                    `;
                });
            });
            
            svgHTML += '</svg>';
            document.getElementById('age-heatmap').innerHTML = svgHTML;
            
            document.querySelectorAll('#age-heatmap .heatmap-cell').forEach(cell => {
                cell.addEventListener('mouseenter', function(e) {
                    const year = this.dataset.year;
                    const age = this.dataset.age;
                    const count = this.dataset.count;
                    showTooltip(`<div class="tooltip-title">${year} - ${age}</div><div class="tooltip-value">Cases: ${count}</div>`, e);
                });
                cell.addEventListener('mouseleave', hideTooltip);
                cell.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function renderRaceHeatmap() {
            const years = ['2008', '2009', '2010', '2011', '2012'];
            
            // Collect all unique races across all years
            const allRaces = new Set();
            years.forEach(year => {
                const yearData = stateData[year]?.race || {};
                Object.keys(yearData).forEach(race => allRaces.add(race));
            });
            
            const races = Array.from(allRaces).sort();
            
            if (races.length === 0) {
                document.getElementById('race-heatmap').innerHTML = '<div class="error">No race data available</div>';
                return;
            }
            
            const heatmapData = years.map(year => {
                const yearData = stateData[year]?.race || {};
                return races.map(race => yearData[race]?.count || 0);
            });

            const maxValue = Math.max(...heatmapData.flat(), 1);
            const cellWidth = 60;
            const cellHeight = 40;
            const padding = { top: 30, right: 10, bottom: 10, left: 180 };
            
            let svgHTML = `<svg viewBox="0 0 ${cellWidth * years.length + padding.left + padding.right} ${cellHeight * races.length + padding.top + padding.bottom}" 
                     xmlns="http://www.w3.org/2000/svg">`;
                     
            years.forEach((year, i) => {
                svgHTML += `<text x="${padding.left + i * cellWidth + cellWidth/2}" y="${padding.top - 10}" 
                          text-anchor="middle" class="heatmap-label">${year}</text>`;
            });
            
            races.forEach((race, j) => {
                const displayName = race.length > 25 ? race.substring(0, 22) + '...' : race;
                svgHTML += `<text x="${padding.left - 10}" y="${padding.top + j * cellHeight + cellHeight/2 + 5}" 
                          text-anchor="end" class="heatmap-label" font-size="10">${displayName}</text>`;
            });
            
            heatmapData.forEach((yearData, i) => {
                yearData.forEach((value, j) => {
                    const intensity = maxValue > 0 ? (value / maxValue) : 0;
                    const color = `rgba(255, 154, 139, ${intensity * 0.7 + 0.3})`;
                    const x = padding.left + i * cellWidth;
                    const y = padding.top + j * cellHeight;
                    
                    svgHTML += `
                        <g class="heatmap-cell" data-year="${years[i]}" data-race="${races[j]}" data-count="${value}">
                            <rect x="${x}" y="${y}" width="${cellWidth-2}" height="${cellHeight-2}" 
                                  fill="${color}" stroke="#e86a5d" stroke-width="1" rx="4"/>
                            <text x="${x + cellWidth/2}" y="${y + cellHeight/2 + 5}" 
                                  text-anchor="middle" class="heatmap-text" font-size="11">${value}</text>
                        </g>
                    `;
                });
            });
            
            svgHTML += '</svg>';
            document.getElementById('race-heatmap').innerHTML = svgHTML;
            
            document.querySelectorAll('#race-heatmap .heatmap-cell').forEach(cell => {
                cell.addEventListener('mouseenter', function(e) {
                    const year = this.dataset.year;
                    const race = this.dataset.race;
                    const count = this.dataset.count;
                    showTooltip(`<div class="tooltip-title">${year} - ${race}</div><div class="tooltip-value">Cases: ${count}</div>`, e);
                });
                cell.addEventListener('mouseleave', hideTooltip);
                cell.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function renderTeenBirths(year) {
            const ageData = stateData[year]?.age;
            if (!ageData) {
                document.getElementById('teen-births-chart').innerHTML = '<div class="error">No age data</div>';
                return;
            }
            
            // Teen: <18
            const teen = ageData['<18'] || { rate: 0, count: 0 };
            
            // Adult: average of 20-24, 25-29, 30-34
            const adult20 = ageData['20-24']?.rate || 0;
            const adult25 = ageData['25-29']?.rate || 0;
            const adult30 = ageData['30-34']?.rate || 0;
            const avgAdult = (adult20 + adult25 + adult30) / 3;
            
            const width = 600;
            const height = 350;
            const padding = { top: 50, right: 40, bottom: 80, left: 70 };
            const barWidth = 100;
            
            let svgHTML = `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;
            
            const maxRate = Math.max(teen.rate, avgAdult, 2.0); // At least 2.0% for scale
            
            // Y-axis with grid lines
            svgHTML += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#d64933" stroke-width="2"/>`;
            
            // Y-axis grid lines and labels
            for (let i = 0; i <= 4; i++) {
                const value = (maxRate * i) / 4;
                const y = height - padding.bottom - (i / 4) * (height - padding.top - padding.bottom);
                svgHTML += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#ffd4c4" stroke-width="1" opacity="0.5"/>`;
                svgHTML += `<text x="${padding.left - 10}" y="${y + 5}" text-anchor="end" class="axis-label" font-size="11">${value.toFixed(1)}%</text>`;
            }
            
            // X-axis
            svgHTML += `<line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" stroke="#d64933" stroke-width="2"/>`;
            
            // Y-axis label
            svgHTML += `<text x="20" y="${(padding.top + height - padding.bottom) / 2}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12" fill="#d64933" transform="rotate(-90, 20, ${(padding.top + height - padding.bottom) / 2})">Preterm Birth Rate (%)</text>`;
            
            // X-axis label
            svgHTML += `<text x="${width/2}" y="${height - 10}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12" fill="#d64933">Age Group</text>`;
            
            // Teen bar
            const teenHeight = (teen.rate / maxRate) * (height - padding.top - padding.bottom);
            const teenY = height - padding.bottom - teenHeight;
            const teenX = width / 2 - barWidth - 40;
            svgHTML += `<rect x="${teenX}" y="${teenY}" width="${barWidth}" height="${teenHeight}" fill="#ff7e7e" rx="4" opacity="0.9"/>`;
            svgHTML += `<text x="${teenX + barWidth/2}" y="${teenY - 10}" text-anchor="middle" class="axis-label" font-size="16" font-weight="700" fill="#d64933">${teen.rate.toFixed(1)}%</text>`;
            svgHTML += `<text x="${teenX + barWidth/2}" y="${teenY - 30}" text-anchor="middle" class="axis-label" font-size="11">${teen.count} cases</text>`;
            svgHTML += `<text x="${teenX + barWidth/2}" y="${height - padding.bottom + 25}" text-anchor="middle" class="axis-label" font-weight="600">Teen (&lt;18)</text>`;
            
            // Adult bar
            const adultHeight = (avgAdult / maxRate) * (height - padding.top - padding.bottom);
            const adultY = height - padding.bottom - adultHeight;
            const adultX = width / 2 + 40;
            svgHTML += `<rect x="${adultX}" y="${adultY}" width="${barWidth}" height="${adultHeight}" fill="#4ade80" rx="4" opacity="0.9"/>`;
            svgHTML += `<text x="${adultX + barWidth/2}" y="${adultY - 10}" text-anchor="middle" class="axis-label" font-size="16" font-weight="700" fill="#059669">${avgAdult.toFixed(1)}%</text>`;
            svgHTML += `<text x="${adultX + barWidth/2}" y="${height - padding.bottom + 25}" text-anchor="middle" class="axis-label" font-weight="600">Adult (20-34)</text>`;
            
            // Title
            svgHTML += `<text x="${width/2}" y="25" text-anchor="middle" class="axis-label" font-size="14" font-weight="600" fill="#d64933">Comparison for ${year}</text>`;
            
            svgHTML += '</svg>';
            document.getElementById('teen-births-chart').innerHTML = svgHTML;
        }

        function renderAdvancedAge(year) {
            const ageData = stateData[year]?.age;
            if (!ageData) {
                document.getElementById('advanced-age-chart').innerHTML = '<div class="error">No age data</div>';
                return;
            }
            
            const age35_39 = ageData['35-39']?.rate || 0;
            const age40plus = ageData['40 and over']?.rate || 0;
            const count35_39 = ageData['35-39']?.count || 0;
            const count40plus = ageData['40 and over']?.count || 0;
            
            const width = 600;
            const height = 350;
            const padding = { top: 50, right: 40, bottom: 80, left: 70 };
            const barWidth = 100;
            
            let svgHTML = `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;
            
            const maxRate = Math.max(age35_39, age40plus, 2.5);
            
            // Y-axis with grid lines
            svgHTML += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#d64933" stroke-width="2"/>`;
            
            // Y-axis grid lines and labels
            for (let i = 0; i <= 4; i++) {
                const value = (maxRate * i) / 4;
                const y = height - padding.bottom - (i / 4) * (height - padding.top - padding.bottom);
                svgHTML += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#ffd4c4" stroke-width="1" opacity="0.5"/>`;
                svgHTML += `<text x="${padding.left - 10}" y="${y + 5}" text-anchor="end" class="axis-label" font-size="11">${value.toFixed(1)}%</text>`;
            }
            
            // X-axis
            svgHTML += `<line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" stroke="#d64933" stroke-width="2"/>`;
            
            // Y-axis label
            svgHTML += `<text x="20" y="${(padding.top + height - padding.bottom) / 2}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12" fill="#d64933" transform="rotate(-90, 20, ${(padding.top + height - padding.bottom) / 2})">Preterm Birth Rate (%)</text>`;
            
            // X-axis label
            svgHTML += `<text x="${width/2}" y="${height - 10}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12" fill="#d64933">Maternal Age Group</text>`;
            
            // 35-39 bar
            const bar1Height = (age35_39 / maxRate) * (height - padding.top - padding.bottom);
            const bar1Y = height - padding.bottom - bar1Height;
            const bar1X = width / 2 - barWidth - 40;
            svgHTML += `<rect x="${bar1X}" y="${bar1Y}" width="${barWidth}" height="${bar1Height}" fill="#fb923c" rx="4" opacity="0.9"/>`;
            svgHTML += `<text x="${bar1X + barWidth/2}" y="${bar1Y - 10}" text-anchor="middle" class="axis-label" font-size="16" font-weight="700" fill="#d64933">${age35_39.toFixed(1)}%</text>`;
            svgHTML += `<text x="${bar1X + barWidth/2}" y="${bar1Y - 30}" text-anchor="middle" class="axis-label" font-size="11">${count35_39} cases</text>`;
            svgHTML += `<text x="${bar1X + barWidth/2}" y="${height - padding.bottom + 25}" text-anchor="middle" class="axis-label" font-weight="600">35-39 years</text>`;
            
            // 40+ bar
            const bar2Height = (age40plus / maxRate) * (height - padding.top - padding.bottom);
            const bar2Y = height - padding.bottom - bar2Height;
            const bar2X = width / 2 + 40;
            svgHTML += `<rect x="${bar2X}" y="${bar2Y}" width="${barWidth}" height="${bar2Height}" fill="#f87171" rx="4" opacity="0.9"/>`;
            svgHTML += `<text x="${bar2X + barWidth/2}" y="${bar2Y - 10}" text-anchor="middle" class="axis-label" font-size="16" font-weight="700" fill="#dc2626">${age40plus.toFixed(1)}%</text>`;
            svgHTML += `<text x="${bar2X + barWidth/2}" y="${bar2Y - 30}" text-anchor="middle" class="axis-label" font-size="11">${count40plus} cases</text>`;
            svgHTML += `<text x="${bar2X + barWidth/2}" y="${height - padding.bottom + 25}" text-anchor="middle" class="axis-label" font-weight="600">40+ years</text>`;
            
            // Title
            svgHTML += `<text x="${width/2}" y="25" text-anchor="middle" class="axis-label" font-size="14" font-weight="600" fill="#d64933">Advanced Maternal Age for ${year}</text>`;
            
            svgHTML += '</svg>';
            document.getElementById('advanced-age-chart').innerHTML = svgHTML;
        }

        function renderAgeBubble(year) {
            const ageData = stateData[year]?.age;
            
            if (!ageData) {
                document.getElementById('age-bubble-chart').innerHTML = '<div class="error">No data</div>';
                return;
            }
            
            const ageGroups = ['15-19', '20-24', '25-29', '30-34', '35-39', '40 and over'];
            const data = ageGroups.filter(ag => ageData[ag]).map(ag => ({
                age: ag,
                rate: ageData[ag].rate,
                count: ageData[ag].count,
                total: ageData[ag].total
            }));
            
            const width = 1000;
            const height = 400;
            const padding = { top: 50, right: 40, bottom: 60, left: 80 };
            
            const maxRate = Math.max(...data.map(d => d.rate));
            const maxCount = Math.max(...data.map(d => d.count));
            const maxTotal = Math.max(...data.map(d => d.total));
            
            let svgHTML = `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;
            
            // Axes
            svgHTML += `<line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" stroke="#ffb8aa" stroke-width="2"/>`;
            svgHTML += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#ffb8aa" stroke-width="2"/>`;
            
            // Labels
            svgHTML += `<text x="${(padding.left + width - padding.right) / 2}" y="${height - 15}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12">Preterm Birth Rate (%)</text>`;
            svgHTML += `<text x="${25}" y="${(padding.top + height - padding.bottom) / 2}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12" transform="rotate(-90, 25, ${(padding.top + height - padding.bottom) / 2})">Case Count</text>`;
            svgHTML += `<text x="${width/2}" y="25" text-anchor="middle" class="axis-label" font-size="14" font-weight="600" fill="#d64933">Age Group Comparison for ${year}</text>`;
            
            // Bubbles
            data.forEach(d => {
                const x = padding.left + (d.rate / maxRate) * (width - padding.left - padding.right);
                const y = height - padding.bottom - (d.count / maxCount) * (height - padding.top - padding.bottom);
                const r = 15 + (d.total / maxTotal) * 35;
                const color = getColorForRate(d.rate);
                
                svgHTML += `
                    <g class="county-circle" data-age="${d.age}" data-rate="${d.rate}" data-count="${d.count}" data-total="${d.total}">
                        <circle cx="${x}" cy="${y}" r="${r}" fill="${color}" opacity="0.6" stroke="#d64933" stroke-width="2"/>
                        <text x="${x}" y="${y + 4}" text-anchor="middle" class="county-text" font-size="11" font-weight="700">${d.age}</text>
                    </g>
                `;
            });
            
            svgHTML += '</svg>';
            document.getElementById('age-bubble-chart').innerHTML = svgHTML;
            
            // Add tooltips
            document.querySelectorAll('#age-bubble-chart .county-circle').forEach(circle => {
                circle.addEventListener('mouseenter', function(e) {
                    const age = this.dataset.age;
                    const rate = this.dataset.rate;
                    const count = this.dataset.count;
                    const total = parseInt(this.dataset.total).toLocaleString();
                    showTooltip(`<div class="tooltip-title">Age ${age}</div><div class="tooltip-value">Rate: ${parseFloat(rate).toFixed(1)}%<br>Cases: ${count}<br>Total Births: ${total}</div>`, e);
                });
                circle.addEventListener('mouseleave', hideTooltip);
            });
        }

        function updateCountySpecific(county) {
            const insightsBox = document.getElementById('county-insights-box');
            
            if (county === 'all') {
                // Show empty state
                insightsBox.style.display = 'none';
                document.getElementById('county-age-chart').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“Š</div>
                        <div class="empty-state-text">Select a county to view trend analysis</div>
                    </div>
                `;
                document.getElementById('county-race-chart').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“ˆ</div>
                        <div class="empty-state-text">Select a county to view case analysis</div>
                    </div>
                `;
                return;
            }
            
            insightsBox.style.display = 'block';
            document.getElementById('selected-county-name').textContent = county;
            
            // Generate insights
            const countyData = countyDataAllYears[county];
            if (countyData) {
                const years = ['2008', '2009', '2010', '2011', '2012'];
                const rates = years.map(y => countyData[y]?.rate || 0).filter(r => r > 0);
                
                if (rates.length > 0) {
                    const avgRate = (rates.reduce((a, b) => a + b, 0) / rates.length).toFixed(2);
                    const trend = rates[rates.length - 1] > rates[0] ? 'increasing' : 'decreasing';
                    const change = ((rates[rates.length - 1] - rates[0]) / rates[0] * 100).toFixed(1);
                    
                    document.getElementById('insight-text').innerHTML = `
                        <strong>${county} County:</strong> Average rate over 2008-2012 is ${avgRate}%. 
                        Trend is ${trend} with a ${Math.abs(change)}% ${trend === 'increasing' ? 'increase' : 'decrease'} from 2008 to 2012.
                        This county contributes approximately ${countyData['2012']?.count || 0} preterm births annually.
                    `;
                } else {
                    document.getElementById('insight-text').innerHTML = `
                        <strong>${county} County:</strong> Insufficient data for trend analysis.
                    `;
                }
            } else {
                document.getElementById('insight-text').innerHTML = `
                    <strong>${county} County:</strong> No data available.
                `;
            }
            
            // Render county-specific charts
            renderCountyAgeAnalysis(county);
            renderCountyRaceAnalysis(county);
        }
        
        function renderCountyAgeAnalysis(county) {
            // Show the county's trend over years with a comparison to state average
            const years = ['2008', '2009', '2010', '2011', '2012'];
            const countyRates = [];
            const stateRates = [];
            
            years.forEach(year => {
                const countyYear = countyDataAllYears[county]?.[year];
                const stateYear = allData[year];
                
                if (countyYear) {
                    countyRates.push(countyYear.rate);
                } else {
                    countyRates.push(null);
                }
                
                // Calculate state average for this year
                if (stateYear) {
                    const rates = Object.values(stateYear).map(d => d.rate);
                    const avgRate = rates.reduce((a, b) => a + b, 0) / rates.length;
                    stateRates.push(avgRate);
                } else {
                    stateRates.push(null);
                }
            });
            
            const width = 600;
            const height = 350;
            const padding = { top: 50, right: 120, bottom: 60, left: 70 };
            
            const validRates = [...countyRates, ...stateRates].filter(r => r !== null);
            const maxRate = Math.max(...validRates);
            const minRate = Math.min(...validRates);
            
            let svgHTML = `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;
            
            // Title
            svgHTML += `<text x="${width/2}" y="25" text-anchor="middle" class="axis-label" font-size="14" font-weight="600" fill="#d64933">${county} County Trend vs. State Average</text>`;
            
            // Y-axis
            svgHTML += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#d64933" stroke-width="2"/>`;
            
            // Y-axis grid lines and labels
            for (let i = 0; i <= 4; i++) {
                const value = minRate + (maxRate - minRate) * (i / 4);
                const y = height - padding.bottom - (i / 4) * (height - padding.top - padding.bottom);
                svgHTML += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#ffd4c4" stroke-width="1" opacity="0.5"/>`;
                svgHTML += `<text x="${padding.left - 10}" y="${y + 5}" text-anchor="end" class="axis-label" font-size="11">${value.toFixed(1)}%</text>`;
            }
            
            // X-axis
            svgHTML += `<line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" stroke="#d64933" stroke-width="2"/>`;
            
            // X-axis labels
            years.forEach((year, i) => {
                const x = padding.left + (i / (years.length - 1)) * (width - padding.left - padding.right);
                svgHTML += `<text x="${x}" y="${height - padding.bottom + 25}" text-anchor="middle" class="axis-label" font-weight="600">${year}</text>`;
            });
            
            // Axis labels
            svgHTML += `<text x="20" y="${(padding.top + height - padding.bottom) / 2}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12" fill="#d64933" transform="rotate(-90, 20, ${(padding.top + height - padding.bottom) / 2})">Preterm Birth Rate (%)</text>`;
            svgHTML += `<text x="${width/2}" y="${height - 10}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12" fill="#d64933">Year</text>`;
            
            // Plot county line
            let countyPoints = [];
            countyRates.forEach((rate, i) => {
                if (rate !== null) {
                    const x = padding.left + (i / (years.length - 1)) * (width - padding.left - padding.right);
                    const y = height - padding.bottom - ((rate - minRate) / (maxRate - minRate)) * (height - padding.top - padding.bottom);
                    countyPoints.push(`${x},${y}`);
                }
            });
            if (countyPoints.length > 0) {
                svgHTML += `<polyline points="${countyPoints.join(' ')}" fill="none" stroke="#ff7e7e" stroke-width="3"/>`;
            }
            
            // Plot state line
            let statePoints = [];
            stateRates.forEach((rate, i) => {
                if (rate !== null) {
                    const x = padding.left + (i / (years.length - 1)) * (width - padding.left - padding.right);
                    const y = height - padding.bottom - ((rate - minRate) / (maxRate - minRate)) * (height - padding.top - padding.bottom);
                    statePoints.push(`${x},${y}`);
                }
            });
            if (statePoints.length > 0) {
                svgHTML += `<polyline points="${statePoints.join(' ')}" fill="none" stroke="#4ade80" stroke-width="3" stroke-dasharray="5,5"/>`;
            }
            
            // Legend
            svgHTML += `<line x1="${width - 110}" y1="50" x2="${width - 80}" y2="50" stroke="#ff7e7e" stroke-width="3"/>`;
            svgHTML += `<text x="${width - 75}" y="55" class="axis-label" font-size="11">${county} County</text>`;
            svgHTML += `<line x1="${width - 110}" y1="70" x2="${width - 80}" y2="70" stroke="#4ade80" stroke-width="3" stroke-dasharray="5,5"/>`;
            svgHTML += `<text x="${width - 75}" y="75" class="axis-label" font-size="11">State Avg</text>`;
            
            svgHTML += '</svg>';
            document.getElementById('county-age-chart').innerHTML = svgHTML;
        }
        
        function renderCountyRaceAnalysis(county) {
            // Show a simple summary since county-level race data is typically not available
            const years = ['2008', '2009', '2010', '2011', '2012'];
            
            const countyData = countyDataAllYears[county];
            if (!countyData) {
                document.getElementById('county-race-chart').innerHTML = '<div class="error">No data available</div>';
                return;
            }
            
            // Get all years data
            const yearlyData = years.map(year => ({
                year,
                rate: countyData[year]?.rate || 0,
                count: countyData[year]?.count || 0,
                totalBirths: countyData[year]?.totalBirths || 0
            })).filter(d => d.rate > 0);
            
            const width = 600;
            const height = 350;
            const padding = { top: 50, right: 40, bottom: 60, left: 70 };
            const barWidth = 60;
            const spacing = 20;
            
            let svgHTML = `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;
            
            // Title
            svgHTML += `<text x="${width/2}" y="25" text-anchor="middle" class="axis-label" font-size="14" font-weight="600" fill="#d64933">${county} County: Cases Over Time</text>`;
            
            const maxCount = Math.max(...yearlyData.map(d => d.count));
            
            // Y-axis
            svgHTML += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#d64933" stroke-width="2"/>`;
            
            // Y-axis grid lines and labels
            for (let i = 0; i <= 4; i++) {
                const value = (maxCount * i) / 4;
                const y = height - padding.bottom - (i / 4) * (height - padding.top - padding.bottom);
                svgHTML += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#ffd4c4" stroke-width="1" opacity="0.5"/>`;
                svgHTML += `<text x="${padding.left - 10}" y="${y + 5}" text-anchor="end" class="axis-label" font-size="11">${Math.round(value)}</text>`;
            }
            
            // X-axis
            svgHTML += `<line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" stroke="#d64933" stroke-width="2"/>`;
            
            // Axis labels
            svgHTML += `<text x="20" y="${(padding.top + height - padding.bottom) / 2}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12" fill="#d64933" transform="rotate(-90, 20, ${(padding.top + height - padding.bottom) / 2})">Number of Cases</text>`;
            svgHTML += `<text x="${width/2}" y="${height - 10}" text-anchor="middle" class="axis-label" font-weight="600" font-size="12" fill="#d64933">Year</text>`;
            
            // Plot bars
            yearlyData.forEach((d, i) => {
                const x = padding.left + 50 + i * (barWidth + spacing);
                const barHeight = (d.count / maxCount) * (height - padding.top - padding.bottom);
                const y = height - padding.bottom - barHeight;
                const color = getColorForRate(d.rate);
                
                svgHTML += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${color}" rx="4" opacity="0.9"/>`;
                svgHTML += `<text x="${x + barWidth/2}" y="${y - 5}" text-anchor="middle" class="axis-label" font-size="12" font-weight="600">${d.count}</text>`;
                svgHTML += `<text x="${x + barWidth/2}" y="${y - 20}" text-anchor="middle" class="axis-label" font-size="10">${d.rate.toFixed(1)}%</text>`;
                svgHTML += `<text x="${x + barWidth/2}" y="${height - padding.bottom + 20}" text-anchor="middle" class="axis-label" font-weight="600">${d.year}</text>`;
            });
            
            svgHTML += '</svg>';
            document.getElementById('county-race-chart').innerHTML = svgHTML;
        }

        function updateDashboard(year) {
            renderMap(year);
            renderAgeChart(year);
            renderRaceChart(year);
            
            // Update age-focused charts with year
            renderTeenBirths(year);
            renderAdvancedAge(year);
            renderAgeBubble(year);
        }

        async function init() {
            const csvData = await loadCSV();
            
            if (csvData) {
                const processed = processData(csvData);
                allData = processed.countyData;
                stateData = processed.stateDataByYear;
                countyDataAllYears = processed.allCountyData;
                
                // Debug output
                console.log('Data processed successfully!');
                console.log('Sample state data for 2012:');
                console.log('Age groups:', Object.keys(stateData['2012']?.age || {}));
                console.log('Race groups:', Object.keys(stateData['2012']?.race || {}));
                
                const yearSelect = document.getElementById('year-select');
                const countySelect = document.getElementById('county-select');
                
                // Populate county dropdown with only counties that have data
                const availableCounties = Object.keys(countyDataAllYears).sort();
                availableCounties.forEach(county => {
                    const option = document.createElement('option');
                    option.value = county;
                    option.textContent = county;
                    countySelect.appendChild(option);
                });
                
                updateDashboard(yearSelect.value);
                renderAgeHeatmap();
                renderRaceHeatmap();
                
                yearSelect.addEventListener('change', (e) => {
                    updateDashboard(e.target.value);
                });
                
                countySelect.addEventListener('change', (e) => {
                    updateCountySpecific(e.target.value);
                });
            }
        }

        init();
    </script>
</body>
</html>
