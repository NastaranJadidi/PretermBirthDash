<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utah Preterm Births Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Crimson+Pro:wght@600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #1e1b2e 0%, #2d1b3d 100%);
            min-height: 100vh;
            color: white;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .title {
            font-family: 'Crimson Pro', serif;
            font-size: 3rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #fce7f3 0%, #ddd6fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #a78bfa;
            font-size: 1.1rem;
            font-style: italic;
        }

        .year-selector {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
        }

        .year-selector label {
            color: #d8b4fe;
            margin-right: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .year-selector select {
            padding: 0.75rem 2rem;
            background: rgba(88, 28, 135, 0.6);
            border: 2px solid #ec4899;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .map-container {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .map-title {
            text-align: center;
            color: #fce7f3;
            font-size: 2rem;
            margin-bottom: 2rem;
        }

        svg {
            width: 100%;
            height: auto;
        }

        .county-circle {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .county-circle:hover {
            filter: brightness(1.2);
        }

        .county-text {
            pointer-events: none;
            fill: white;
            font-weight: 700;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #d8b4fe;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .loading {
            text-align: center;
            color: #fce7f3;
            padding: 3rem;
            font-size: 1.2rem;
        }

        .error {
            text-align: center;
            color: #fca5a5;
            padding: 2rem;
            background: rgba(220, 38, 38, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(220, 38, 38, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ec4899;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #d8b4fe;
            font-size: 0.95rem;
        }

        .debug-info {
            background: rgba(30, 41, 59, 0.8);
            padding: 1rem;
            margin-top: 2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #cbd5e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Utah Preterm Births Dashboard</h1>
            <p class="subtitle">32-33 Weeks Gestation (2003-2012)</p>
        </div>

        <div class="year-selector">
            <label for="year-select">Select Year:</label>
            <select id="year-select">
                <option value="2012" selected>2012</option>
                <option value="2011">2011</option>
                <option value="2010">2010</option>
                <option value="2009">2009</option>
                <option value="2008">2008</option>
                <option value="2007">2007</option>
                <option value="2006">2006</option>
                <option value="2005">2005</option>
                <option value="2004">2004</option>
                <option value="2003">2003</option>
            </select>
        </div>

        <div id="stats-container" class="stats-grid">
            <div class="loading">Loading statistics...</div>
        </div>

        <div class="map-container">
            <h2 class="map-title" id="map-title">Utah Counties - Loading...</h2>
            <div id="map-content">
                <div class="loading">Loading map data...</div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #6ee7b7;"></div>
                    <span>Low (&lt;1.0%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fcd34d;"></div>
                    <span>Moderate (1.0-1.3%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fdba74;"></div>
                    <span>Elevated (1.3-1.7%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fca5a5;"></div>
                    <span>High (&gt;1.7%)</span>
                </div>
            </div>
        </div>

        <!-- Debug info (remove after testing) -->
        <div id="debug-info" class="debug-info" style="display: none;">
            <h3>Debug Information:</h3>
            <div id="debug-content"></div>
        </div>
    </div>

    <script>
        // GitHub raw file URL for your CSV
        const CSV_URL = 'Preterm_Births_32-33_Weeks_Gestation_Counties_In_Utah_2003-2012_20260122.csv';
        
        // County position mapping for visualization
        const COUNTY_POSITIONS = {
            'Utah - Cache': { x: 52, y: 25, name: 'Cache' },
            'Utah - Weber': { x: 52, y: 42, name: 'Weber' },
            'Utah - Davis': { x: 50, y: 48, name: 'Davis' },
            'Utah - Salt Lake': { x: 50, y: 55, name: 'Salt Lake' },
            'Utah - Utah': { x: 50, y: 65, name: 'Utah' },
            'Utah - Washington': { x: 25, y: 85, name: 'Washington' },
            'Utah - Box Elder': { x: 52, y: 30, name: 'Box Elder' },
            'Utah - Tooele': { x: 35, y: 55, name: 'Tooele' },
            'Utah - Iron': { x: 25, y: 75, name: 'Iron' },
            'Utah - Sevier': { x: 40, y: 70, name: 'Sevier' },
            'Utah - Uintah': { x: 70, y: 45, name: 'Uintah' }
        };

        let allData = {};

        function getColorForRate(rate) {
            if (!rate) return '#e5e7eb';
            const rateNum = parseFloat(rate);
            if (rateNum < 1.0) return '#6ee7b7';
            if (rateNum < 1.3) return '#fcd34d';
            if (rateNum < 1.7) return '#fdba74';
            return '#fca5a5';
        }

        async function loadCSV() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.error('Error loading CSV:', error);
                document.getElementById('map-content').innerHTML = `
                    <div class="error">
                        <h3>Error Loading Data</h3>
                        <p>Could not load CSV file. Make sure it's in the same directory as this HTML file.</p>
                        <p style="font-size: 0.9rem; margin-top: 1rem;">Looking for: ${CSV_URL}</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Error: ${error.message}</p>
                    </div>
                `;
                return null;
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            
            // Parse first line to get headers
            const firstLine = lines[0];
            const headers = [];
            let inQuotes = false;
            let currentField = '';
            
            for (let i = 0; i < firstLine.length; i++) {
                const char = firstLine[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    headers.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            headers.push(currentField.trim()); // Add last field
            
            // Parse data rows
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const line = lines[i];
                const values = [];
                inQuotes = false;
                currentField = '';
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                values.push(currentField.trim()); // Add last field
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                data.push(row);
            }
            
            console.log(`Parsed ${data.length} rows with ${headers.length} columns`);
            return { headers, data };
        }

        function processData(csvData) {
            const processed = {};
            let rowsProcessed = 0;
            
            csvData.data.forEach(row => {
                const timeframe = row['Timeframe'];
                const locale = row['Locale'];
                const localeLevel = row['Locale Level'];
                const dimensionList = row['Dimension List'];
                const numericValue = row['Numeric Value'];
                const numerator = row['Numerator'];
                const denominator = row['Denominator'];
                
                // Only process county-level data with "Total" dimension
                if (localeLevel !== 'County' || dimensionList !== 'Total') return;
                if (numericValue === 'DSU' || !numericValue || numericValue === '') return;
                
                // Extract year from timeframe
                let year = timeframe;
                if (timeframe.includes('-')) {
                    year = timeframe.split('-')[1].trim();
                }
                
                if (!processed[year]) {
                    processed[year] = {};
                }
                
                const position = COUNTY_POSITIONS[locale];
                if (!position) {
                    console.log(`No position for county: ${locale}`);
                    return;
                }
                
                // Remove commas and parse numbers
                const cleanNumerator = numerator.replace(/,/g, '');
                const cleanDenominator = denominator.replace(/,/g, '');
                
                processed[year][locale] = {
                    rate: parseFloat(numericValue.replace('%', '')),
                    count: parseInt(cleanNumerator) || 0,
                    totalBirths: parseInt(cleanDenominator) || 0,
                    x: position.x,
                    y: position.y,
                    name: position.name
                };
                
                rowsProcessed++;
            });
            
            console.log(`Processed ${rowsProcessed} county records`);
            console.log('Years found:', Object.keys(processed));
            return processed;
        }

        function renderStats(year) {
            const yearData = allData[year];
            if (!yearData || Object.keys(yearData).length === 0) {
                document.getElementById('stats-container').innerHTML = `
                    <div class="error">No data available for year ${year}</div>
                `;
                return;
            }

            // Calculate totals
            let totalCases = 0;
            let totalBirths = 0;
            let rates = [];

            Object.values(yearData).forEach(county => {
                totalCases += county.count;
                totalBirths += county.totalBirths;
                rates.push(county.rate);
            });

            const avgRate = (totalCases / totalBirths * 100).toFixed(2);
            const maxRate = Math.max(...rates).toFixed(1);

            document.getElementById('stats-container').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalCases}</div>
                    <div class="stat-label">Total Cases</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalBirths.toLocaleString()}</div>
                    <div class="stat-label">Total Births</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgRate}%</div>
                    <div class="stat-label">Overall Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${maxRate}%</div>
                    <div class="stat-label">Highest County Rate</div>
                </div>
            `;
        }

        function renderMap(year) {
            const yearData = allData[year];
            
            if (!yearData || Object.keys(yearData).length === 0) {
                document.getElementById('map-content').innerHTML = `
                    <div class="error">No data available for year ${year}</div>
                `;
                return;
            }

            document.getElementById('map-title').textContent = `Utah Counties - ${year}`;

            const svg = `
                <svg viewBox="0 0 800 1000" xmlns="http://www.w3.org/2000/svg">
                    <!-- Utah state outline -->
                    <path d="M 240 80 L 560 80 L 560 920 L 240 920 L 240 720 L 160 720 L 160 320 L 240 320 Z" 
                          fill="rgba(236, 72, 153, 0.08)" 
                          stroke="rgba(236, 72, 153, 0.4)" 
                          stroke-width="2"/>
                    
                    <!-- Grid lines -->
                    <line x1="160" y1="320" x2="560" y2="320" stroke="rgba(236, 72, 153, 0.15)" stroke-width="1" stroke-dasharray="5,5" />
                    <line x1="160" y1="520" x2="560" y2="520" stroke="rgba(236, 72, 153, 0.15)" stroke-width="1" stroke-dasharray="5,5" />
                    <line x1="160" y1="720" x2="560" y2="720" stroke="rgba(236, 72, 153, 0.15)" stroke-width="1" stroke-dasharray="5,5" />
                    
                    ${Object.entries(yearData).map(([locale, data]) => {
                        const cx = (data.x / 100) * 800;
                        const cy = (data.y / 100) * 1000;
                        const r = 60;
                        const color = getColorForRate(data.rate);
                        
                        return `
                            <g class="county-circle" data-county="${data.name}" data-rate="${data.rate}" data-count="${data.count}">
                                <circle cx="${cx}" cy="${cy}" r="${r}" fill="${color}" opacity="0.9" 
                                        stroke="rgba(255, 255, 255, 0.4)" stroke-width="3"/>
                                <text x="${cx}" y="${cy - 10}" text-anchor="middle" class="county-text" font-size="24">${data.rate.toFixed(1)}%</text>
                                <text x="${cx}" y="${cy + 12}" text-anchor="middle" class="county-text" font-size="14">${data.name}</text>
                                <text x="${cx}" y="${cy + 30}" text-anchor="middle" class="county-text" font-size="12" opacity="0.8">${data.count} cases</text>
                            </g>
                        `;
                    }).join('')}
                </svg>
            `;
            
            document.getElementById('map-content').innerHTML = svg;
            
            // Add hover effects
            document.querySelectorAll('.county-circle').forEach(circle => {
                circle.addEventListener('mouseenter', function() {
                    const circleEl = this.querySelector('circle');
                    const currentR = circleEl.getAttribute('r');
                    circleEl.setAttribute('data-original-r', currentR);
                    circleEl.setAttribute('r', parseFloat(currentR) * 1.2);
                });

                circle.addEventListener('mouseleave', function() {
                    const circleEl = this.querySelector('circle');
                    const originalR = circleEl.getAttribute('data-original-r');
                    circleEl.setAttribute('r', originalR);
                });
            });
        }

        async function init() {
            const csvData = await loadCSV();
            
            if (csvData) {
                allData = processData(csvData);
                console.log('Processed data:', allData);
                
                // Show debug info
                const debugContent = document.getElementById('debug-content');
                debugContent.innerHTML = `
                    <p><strong>Years available:</strong> ${Object.keys(allData).join(', ')}</p>
                    <p><strong>Total rows parsed:</strong> ${csvData.data.length}</p>
                `;
                
                const yearSelect = document.getElementById('year-select');
                const currentYear = yearSelect.value;
                
                renderStats(currentYear);
                renderMap(currentYear);
                
                yearSelect.addEventListener('change', (e) => {
                    renderStats(e.target.value);
                    renderMap(e.target.value);
                });
            }
        }

        init();
    </script>
</body>
</html>
