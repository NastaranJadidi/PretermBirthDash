<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utah Preterm Births Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 50%, #c4b5fd 100%);
            color: #1f2937;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }

        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, #c084fc 0%, #a78bfa 100%);
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #9333ea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(147, 51, 234, 0.2);
        }

        .title-section h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .title-section p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .year-control-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .interaction-hint {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fde047;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .interaction-hint::before,
        .interaction-hint::after {
            content: '→';
            font-size: 0.9rem;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .year-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .year-control label {
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .year-control select {
            padding: 0.5rem 1.5rem;
            background: white;
            border: 2px solid #9333ea;
            border-radius: 8px;
            color: #6b21a8;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(147, 51, 234, 0.2);
        }

        .year-control select:hover {
            background: #faf5ff;
            border-color: #7c3aed;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(147, 51, 234, 0.3);
        }

        .year-control select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.3);
        }

        /* Main Content */
        .dashboard-main {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: calc(100vh - 90px);
            gap: 0;
        }

        /* Left Side - Map */
        .map-section {
            background: rgba(255, 255, 255, 0.9);
            border-right: 2px solid #c084fc;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 4px 0 6px rgba(147, 51, 234, 0.1);
        }

        .map-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #6b21a8;
        }

        .map-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 400px;
            background: rgba(167, 139, 250, 0.1);
            border-radius: 12px;
            padding: 1rem;
        }

        .map-legend {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(167, 139, 250, 0.15);
            border-radius: 8px;
            border: 1px solid #c084fc;
        }

        .legend-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #6b21a8;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #4c1d95;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #6b21a8;
        }

        /* Right Side - Visualizations */
        .viz-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            background: #c084fc;
        }

        .viz-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }

        .viz-header {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e9d5ff;
        }

        .viz-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #6b21a8;
            margin-bottom: 0.25rem;
        }

        .viz-header p {
            font-size: 0.8rem;
            color: #7c3aed;
        }

        .viz-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 200px;
        }

        /* SVG Styles */
        svg {
            width: 100%;
            height: 100%;
        }

        .county-circle {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .county-circle:hover {
            filter: brightness(1.1);
        }

        .county-text {
            pointer-events: none;
            fill: #1f2937;
            font-weight: 600;
        }

        /* Bar Chart Styles */
        .bar {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .bar:hover rect {
            opacity: 0.8;
        }

        .axis-label {
            fill: #6b21a8;
            font-size: 11px;
        }

        .axis-line {
            stroke: #c084fc;
            stroke-width: 1;
        }

        /* Heatmap Styles */
        .heatmap-cell {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .heatmap-cell:hover rect {
            stroke: #6b21a8;
            stroke-width: 2;
        }

        .heatmap-text {
            fill: #1f2937;
            font-size: 10px;
            font-weight: 600;
            pointer-events: none;
        }

        .heatmap-label {
            fill: #6b21a8;
            font-size: 11px;
        }

        /* Loading State */
        .loading {
            text-align: center;
            color: #7c3aed;
            padding: 2rem;
        }

        .error {
            text-align: center;
            color: #dc2626;
            padding: 1rem;
            background: rgba(220, 38, 38, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid #fca5a5;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: linear-gradient(135deg, #6b21a8 0%, #7c3aed 100%);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            border: 2px solid #a78bfa;
            box-shadow: 0 4px 12px rgba(107, 33, 168, 0.4);
            max-width: 250px;
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .tooltip-value {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="title-section">
                <h1>Utah Preterm Births Analysis</h1>
                <p>32-33 Weeks Gestation • 2008-2012 • County-Level Data</p>
            </div>
            <div class="year-control-wrapper">
                <div class="interaction-hint">You Can Interact Here</div>
                <div class="year-control">
                    <label for="year-select">Year:</label>
                    <select id="year-select">
                        <option value="2012" selected>2012</option>
                        <option value="2011">2011</option>
                        <option value="2010">2010</option>
                        <option value="2009">2009</option>
                        <option value="2008">2008</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-main">
            <!-- Left: Map -->
            <div class="map-section">
                <h2 class="map-title">Geographic Distribution</h2>
                <div class="map-container" id="map-container">
                    <div class="loading">Loading map...</div>
                </div>
                <div class="map-legend">
                    <div class="legend-title">Preterm Birth Rate</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4ade80;"></div>
                            <span>Low (&lt;1.0%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fbbf24;"></div>
                            <span>Moderate (1.0-1.3%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fb923c;"></div>
                            <span>Elevated (1.3-1.7%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f87171;"></div>
                            <span>High (&gt;1.7%)</span>
                        </div>
                    </div>
                    <div class="legend-title" style="margin-top: 1rem;">Circle Size</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span>Proportional to total births</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: 4 Visualizations -->
            <div class="viz-section">
                <!-- Top Left: Age Distribution -->
                <div class="viz-panel">
                    <div class="viz-header">
                        <h3>Preterm Births by Maternal Age</h3>
                        <p>Rate by age group</p>
                    </div>
                    <div class="viz-content" id="age-chart">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Top Right: Race Distribution -->
                <div class="viz-panel">
                    <div class="viz-header">
                        <h3>Preterm Births by Race/Ethnicity</h3>
                        <p>Rate by demographic group</p>
                    </div>
                    <div class="viz-content" id="race-chart">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Bottom Left: Age Heatmap -->
                <div class="viz-panel">
                    <div class="viz-header">
                        <h3>Age Group Trends</h3>
                        <p>Cases by year and age</p>
                    </div>
                    <div class="viz-content" id="age-heatmap">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Bottom Right: Race Heatmap -->
                <div class="viz-panel">
                    <div class="viz-header">
                        <h3>Race/Ethnicity Trends</h3>
                        <p>Cases by year and demographic</p>
                    </div>
                    <div class="viz-content" id="race-heatmap">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        const CSV_URL = 'Preterm_Births_32-33_Weeks_Gestation_Counties_In_Utah_2003-2012_20260122.csv';
        
        const COUNTY_POSITIONS = {
            'Utah - Cache': { x: 52, y: 15, name: 'Cache' },
            'Utah - Weber': { x: 52, y: 30, name: 'Weber' },
            'Utah - Davis': { x: 50, y: 38, name: 'Davis' },
            'Utah - Salt Lake': { x: 50, y: 50, name: 'Salt Lake' },
            'Utah - Utah': { x: 50, y: 65, name: 'Utah' },
            'Utah - Washington': { x: 25, y: 90, name: 'Washington' },
            'Utah - Box Elder': { x: 52, y: 22, name: 'Box Elder' },
            'Utah - Tooele': { x: 35, y: 50, name: 'Tooele' },
            'Utah - Iron': { x: 25, y: 80, name: 'Iron' },
            'Utah - Sevier': { x: 40, y: 70, name: 'Sevier' },
            'Utah - Uintah': { x: 75, y: 40, name: 'Uintah' }
        };

        let allData = {};
        let stateData = {};
        const tooltip = document.getElementById('tooltip');

        function getColorForRate(rate) {
            if (!rate) return '#cbd5e1';
            const rateNum = parseFloat(rate);
            if (rateNum < 1.0) return '#4ade80';
            if (rateNum < 1.3) return '#fbbf24';
            if (rateNum < 1.7) return '#fb923c';
            return '#f87171';
        }

        function showTooltip(html, event) {
            tooltip.innerHTML = html;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            tooltip.classList.remove('show');
        }

        async function loadCSV() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('map-container').innerHTML = '<div class="error">Could not load CSV file. Make sure it\'s in the same directory.</div>';
                return null;
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const firstLine = lines[0];
            const headers = [];
            let inQuotes = false;
            let currentField = '';
            
            for (let i = 0; i < firstLine.length; i++) {
                const char = firstLine[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    headers.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            headers.push(currentField.trim());
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const line = lines[i];
                const values = [];
                inQuotes = false;
                currentField = '';
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                values.push(currentField.trim());
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                data.push(row);
            }
            
            return { headers, data };
        }

        function processData(csvData) {
            const countyData = {};
            const stateDataByYear = {};
            const validYears = ['2008', '2009', '2010', '2011', '2012'];
            
            csvData.data.forEach(row => {
                const timeframe = row['Timeframe'];
                const locale = row['Locale'];
                const localeLevel = row['Locale Level'];
                const dimensionList = row['Dimension List'];
                const numericValue = row['Numeric Value'];
                const numerator = row['Numerator'];
                const denominator = row['Denominator'];
                const age = row['Age'];
                const raceEthnicity = row['Race Ethnicity'];
                
                if (!validYears.includes(timeframe)) return;
                if (numericValue === 'DSU' || !numericValue || numericValue === '') return;
                
                const year = timeframe;
                
                // Process COUNTY data
                if (localeLevel === 'County' && dimensionList === 'Total') {
                    const position = COUNTY_POSITIONS[locale];
                    if (!position) return;
                    
                    if (!countyData[year]) countyData[year] = {};
                    
                    const cleanNumerator = numerator.replace(/,/g, '');
                    const cleanDenominator = denominator.replace(/,/g, '');
                    
                    countyData[year][locale] = {
                        rate: parseFloat(numericValue.replace('%', '')),
                        count: parseInt(cleanNumerator) || 0,
                        totalBirths: parseInt(cleanDenominator) || 0,
                        x: position.x,
                        y: position.y,
                        name: position.name
                    };
                }
                
                // Process STATE-level data for age and race
                if (localeLevel === 'State' && locale === 'Utah') {
                    if (!stateDataByYear[year]) {
                        stateDataByYear[year] = {
                            age: {},
                            race: {}
                        };
                    }
                    
                    // Age groups
                    if (age && age !== '' && !raceEthnicity) {
                        const ageGroup = age.replace('Aged ', '').replace(' years', '').replace(' (Of mother)', '').trim();
                        if (!stateDataByYear[year].age[ageGroup]) {
                            const cleanNum = numerator.replace(/,/g, '');
                            const cleanDenom = denominator.replace(/,/g, '');
                            stateDataByYear[year].age[ageGroup] = {
                                rate: parseFloat(numericValue.replace('%', '')),
                                count: parseInt(cleanNum) || 0,
                                total: parseInt(cleanDenom) || 0
                            };
                        }
                    }
                    
                    // Race/ethnicity groups
                    if (raceEthnicity && raceEthnicity !== '' && dimensionList.includes(raceEthnicity)) {
                        if (!stateDataByYear[year].race[raceEthnicity]) {
                            const cleanNum = numerator.replace(/,/g, '');
                            const cleanDenom = denominator.replace(/,/g, '');
                            stateDataByYear[year].race[raceEthnicity] = {
                                rate: parseFloat(numericValue.replace('%', '')),
                                count: parseInt(cleanNum) || 0,
                                total: parseInt(cleanDenom) || 0
                            };
                        }
                    }
                }
            });
            
            return { countyData, stateDataByYear };
        }

        function renderMap(year) {
            const yearData = allData[year];
            if (!yearData || Object.keys(yearData).length === 0) {
                document.getElementById('map-container').innerHTML = '<div class="error">No data for ' + year + '</div>';
                return;
            }

            const maxBirths = Math.max(...Object.values(yearData).map(d => d.totalBirths));
            const minBirths = Math.min(...Object.values(yearData).map(d => d.totalBirths));

            let svgHTML = `
                <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg" style="max-width: 350px;">
                    <path d="M 30 5 L 70 5 L 70 110 L 30 110 L 30 85 L 20 85 L 20 30 L 30 30 Z" 
                          fill="rgba(167, 139, 250, 0.15)" 
                          stroke="#a78bfa" 
                          stroke-width="0.8"/>
            `;
            
            Object.entries(yearData).forEach(([locale, data]) => {
                const cx = data.x;
                const cy = data.y;
                const r = 5 + ((data.totalBirths - minBirths) / (maxBirths - minBirths)) * 7;
                const color = getColorForRate(data.rate);
                
                svgHTML += `
                    <g class="county-circle" data-county="${data.name}" data-rate="${data.rate}" data-count="${data.count}" data-births="${data.totalBirths}">
                        <circle cx="${cx}" cy="${cy}" r="${r}" fill="${color}" opacity="0.85" 
                                stroke="#6b21a8" stroke-width="0.8"/>
                        <text x="${cx}" y="${cy + 1}" text-anchor="middle" class="county-text" font-size="3">${data.rate.toFixed(1)}%</text>
                    </g>
                `;
            });
            
            svgHTML += '</svg>';
            document.getElementById('map-container').innerHTML = svgHTML;
            
            // Add event listeners
            document.querySelectorAll('.county-circle').forEach(circle => {
                circle.addEventListener('mouseenter', function(e) {
                    const name = this.dataset.county;
                    const rate = this.dataset.rate;
                    const count = this.dataset.count;
                    const births = parseInt(this.dataset.births).toLocaleString();
                    showTooltip(`<div class="tooltip-title">${name} County</div><div class="tooltip-value">Rate: ${parseFloat(rate).toFixed(1)}%<br>Cases: ${count}<br>Total Births: ${births}</div>`, e);
                });
                circle.addEventListener('mouseleave', hideTooltip);
                circle.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function renderAgeChart(year) {
            const data = stateData[year]?.age;
            if (!data) {
                document.getElementById('age-chart').innerHTML = '<div class="error">No age data</div>';
                return;
            }

            const ageGroups = ['15-19', '20-24', '25-29', '30-34', '35-39', '40 and over'];
            const chartData = ageGroups
                .filter(ag => data[ag])
                .map(ag => ({ age: ag, ...data[ag] }));

            if (chartData.length === 0) {
                document.getElementById('age-chart').innerHTML = '<div class="error">No data</div>';
                return;
            }

            const maxRate = Math.max(...chartData.map(d => d.rate));
            const barHeight = 35;
            const padding = { top: 10, right: 60, bottom: 25, left: 80 };
            const chartHeight = chartData.length * barHeight + padding.top + padding.bottom;
            const chartWidth = 500;

            let svgHTML = `<svg viewBox="0 0 ${chartWidth} ${chartHeight}" xmlns="http://www.w3.org/2000/svg">`;
            
            chartData.forEach((d, i) => {
                const barWidth = (d.rate / maxRate) * (chartWidth - padding.left - padding.right);
                const y = padding.top + i * barHeight;
                
                svgHTML += `
                    <g class="bar" data-age="${d.age}" data-rate="${d.rate}" data-count="${d.count}">
                        <text x="${padding.left - 10}" y="${y + 18}" text-anchor="end" class="axis-label">${d.age}</text>
                        <rect x="${padding.left}" y="${y}" width="${barWidth}" height="${barHeight - 10}" 
                              fill="${getColorForRate(d.rate)}" rx="3"/>
                        <text x="${padding.left + barWidth + 5}" y="${y + 18}" class="axis-label" fill="#6b21a8">${d.rate.toFixed(1)}%</text>
                    </g>
                `;
            });
            
            svgHTML += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${chartHeight - padding.bottom}" class="axis-line"/></svg>`;
            
            document.getElementById('age-chart').innerHTML = svgHTML;
            
            // Add event listeners
            document.querySelectorAll('#age-chart .bar').forEach(bar => {
                bar.addEventListener('mouseenter', function(e) {
                    const age = this.dataset.age;
                    const rate = this.dataset.rate;
                    const count = this.dataset.count;
                    showTooltip(`<div class="tooltip-title">Age ${age}</div><div class="tooltip-value">Rate: ${parseFloat(rate).toFixed(1)}%<br>Cases: ${count}</div>`, e);
                });
                bar.addEventListener('mouseleave', hideTooltip);
                bar.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function renderRaceChart(year) {
            const data = stateData[year]?.race;
            if (!data) {
                document.getElementById('race-chart').innerHTML = '<div class="error">No race data</div>';
                return;
            }

            const chartData = Object.entries(data)
                .map(([race, values]) => ({ race, ...values }))
                .sort((a, b) => b.rate - a.rate);

            if (chartData.length === 0) {
                document.getElementById('race-chart').innerHTML = '<div class="error">No data</div>';
                return;
            }

            const maxRate = Math.max(...chartData.map(d => d.rate));
            const barHeight = 35;
            const padding = { top: 10, right: 60, bottom: 25, left: 180 };
            const chartHeight = chartData.length * barHeight + padding.top + padding.bottom;
            const chartWidth = 500;

            let svgHTML = `<svg viewBox="0 0 ${chartWidth} ${chartHeight}" xmlns="http://www.w3.org/2000/svg">`;
            
            chartData.forEach((d, i) => {
                const barWidth = (d.rate / maxRate) * (chartWidth - padding.left - padding.right);
                const y = padding.top + i * barHeight;
                const displayName = d.race.length > 20 ? d.race.substring(0, 17) + '...' : d.race;
                
                svgHTML += `
                    <g class="bar" data-race="${d.race}" data-rate="${d.rate}" data-count="${d.count}">
                        <text x="${padding.left - 10}" y="${y + 18}" text-anchor="end" class="axis-label">${displayName}</text>
                        <rect x="${padding.left}" y="${y}" width="${barWidth}" height="${barHeight - 10}" 
                              fill="${getColorForRate(d.rate)}" rx="3"/>
                        <text x="${padding.left + barWidth + 5}" y="${y + 18}" class="axis-label" fill="#6b21a8">${d.rate.toFixed(1)}%</text>
                    </g>
                `;
            });
            
            svgHTML += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${chartHeight - padding.bottom}" class="axis-line"/></svg>`;
            
            document.getElementById('race-chart').innerHTML = svgHTML;
            
            // Add event listeners
            document.querySelectorAll('#race-chart .bar').forEach(bar => {
                bar.addEventListener('mouseenter', function(e) {
                    const race = this.dataset.race;
                    const rate = this.dataset.rate;
                    const count = this.dataset.count;
                    showTooltip(`<div class="tooltip-title">${race}</div><div class="tooltip-value">Rate: ${parseFloat(rate).toFixed(1)}%<br>Cases: ${count}</div>`, e);
                });
                bar.addEventListener('mouseleave', hideTooltip);
                bar.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function renderAgeHeatmap() {
            const years = ['2008', '2009', '2010', '2011', '2012'];
            const ageGroups = ['15-19', '20-24', '25-29', '30-34', '35-39', '40 and over'];
            
            const heatmapData = years.map(year => {
                const yearData = stateData[year]?.age || {};
                return ageGroups.map(ag => yearData[ag]?.count || 0);
            });

            const maxValue = Math.max(...heatmapData.flat());
            const cellWidth = 60;
            const cellHeight = 40;
            const padding = { top: 30, right: 10, bottom: 10, left: 80 };
            
            let svgHTML = `<svg viewBox="0 0 ${cellWidth * years.length + padding.left + padding.right} ${cellHeight * ageGroups.length + padding.top + padding.bottom}" 
                     xmlns="http://www.w3.org/2000/svg">`;
                     
            years.forEach((year, i) => {
                svgHTML += `<text x="${padding.left + i * cellWidth + cellWidth/2}" y="${padding.top - 10}" 
                          text-anchor="middle" class="heatmap-label">${year}</text>`;
            });
            
            ageGroups.forEach((ag, j) => {
                svgHTML += `<text x="${padding.left - 10}" y="${padding.top + j * cellHeight + cellHeight/2 + 5}" 
                          text-anchor="end" class="heatmap-label">${ag}</text>`;
            });
            
            heatmapData.forEach((yearData, i) => {
                yearData.forEach((value, j) => {
                    const intensity = value / maxValue;
                    const color = `rgba(192, 132, 252, ${intensity * 0.7 + 0.3})`;
                    const x = padding.left + i * cellWidth;
                    const y = padding.top + j * cellHeight;
                    
                    svgHTML += `
                        <g class="heatmap-cell" data-year="${years[i]}" data-age="${ageGroups[j]}" data-count="${value}">
                            <rect x="${x}" y="${y}" width="${cellWidth-2}" height="${cellHeight-2}" 
                                  fill="${color}" stroke="#a78bfa" stroke-width="1" rx="3"/>
                            <text x="${x + cellWidth/2}" y="${y + cellHeight/2 + 5}" 
                                  text-anchor="middle" class="heatmap-text">${value}</text>
                        </g>
                    `;
                });
            });
            
            svgHTML += '</svg>';
            document.getElementById('age-heatmap').innerHTML = svgHTML;
            
            // Add event listeners
            document.querySelectorAll('#age-heatmap .heatmap-cell').forEach(cell => {
                cell.addEventListener('mouseenter', function(e) {
                    const year = this.dataset.year;
                    const age = this.dataset.age;
                    const count = this.dataset.count;
                    showTooltip(`<div class="tooltip-title">${year} - ${age}</div><div class="tooltip-value">Cases: ${count}</div>`, e);
                });
                cell.addEventListener('mouseleave', hideTooltip);
                cell.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function renderRaceHeatmap() {
            const years = ['2008', '2009', '2010', '2011', '2012'];
            const races = ['White', 'Hispanic or Latino', 'Asian or Pacific Islander', 'Black or African American'];
            
            const heatmapData = years.map(year => {
                const yearData = stateData[year]?.race || {};
                return races.map(race => yearData[race]?.count || 0);
            });

            const maxValue = Math.max(...heatmapData.flat());
            const cellWidth = 60;
            const cellHeight = 40;
            const padding = { top: 30, right: 10, bottom: 10, left: 140 };
            
            let svgHTML = `<svg viewBox="0 0 ${cellWidth * years.length + padding.left + padding.right} ${cellHeight * races.length + padding.top + padding.bottom}" 
                     xmlns="http://www.w3.org/2000/svg">`;
                     
            years.forEach((year, i) => {
                svgHTML += `<text x="${padding.left + i * cellWidth + cellWidth/2}" y="${padding.top - 10}" 
                          text-anchor="middle" class="heatmap-label">${year}</text>`;
            });
            
            races.forEach((race, j) => {
                const displayName = race.length > 18 ? race.substring(0, 15) + '...' : race;
                svgHTML += `<text x="${padding.left - 10}" y="${padding.top + j * cellHeight + cellHeight/2 + 5}" 
                          text-anchor="end" class="heatmap-label">${displayName}</text>`;
            });
            
            heatmapData.forEach((yearData, i) => {
                yearData.forEach((value, j) => {
                    const intensity = value / maxValue;
                    const color = `rgba(251, 191, 36, ${intensity * 0.7 + 0.3})`;
                    const x = padding.left + i * cellWidth;
                    const y = padding.top + j * cellHeight;
                    
                    svgHTML += `
                        <g class="heatmap-cell" data-year="${years[i]}" data-race="${races[j]}" data-count="${value}">
                            <rect x="${x}" y="${y}" width="${cellWidth-2}" height="${cellHeight-2}" 
                                  fill="${color}" stroke="#d97706" stroke-width="1" rx="3"/>
                            <text x="${x + cellWidth/2}" y="${y + cellHeight/2 + 5}" 
                                  text-anchor="middle" class="heatmap-text">${value}</text>
                        </g>
                    `;
                });
            });
            
            svgHTML += '</svg>';
            document.getElementById('race-heatmap').innerHTML = svgHTML;
            
            // Add event listeners
            document.querySelectorAll('#race-heatmap .heatmap-cell').forEach(cell => {
                cell.addEventListener('mouseenter', function(e) {
                    const year = this.dataset.year;
                    const race = this.dataset.race;
                    const count = this.dataset.count;
                    showTooltip(`<div class="tooltip-title">${year} - ${race}</div><div class="tooltip-value">Cases: ${count}</div>`, e);
                });
                cell.addEventListener('mouseleave', hideTooltip);
                cell.addEventListener('mousemove', function(e) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
            });
        }

        function updateDashboard(year) {
            renderMap(year);
            renderAgeChart(year);
            renderRaceChart(year);
        }

        async function init() {
            const csvData = await loadCSV();
            
            if (csvData) {
                const processed = processData(csvData);
                allData = processed.countyData;
                stateData = processed.stateDataByYear;
                
                console.log('Data loaded successfully');
                
                const yearSelect = document.getElementById('year-select');
                updateDashboard(yearSelect.value);
                renderAgeHeatmap();
                renderRaceHeatmap();
                
                yearSelect.addEventListener('change', (e) => {
                    updateDashboard(e.target.value);
                });
            }
        }

        init();
    </script>
</body>
</html>
